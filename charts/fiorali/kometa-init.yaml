- name: kometa-init
  image: docker.io/alpine/curl:latest@sha256:2f0ecea48fe8e7131314d6655f99d001f798cf566d57de0075c387a88487acc2
  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
      - ALL
    privileged: false
    readOnlyRootFilesystem: true
    runAsUser: 911
  resources:
    limits:
      cpu: 25m
      memory: 25Mi
    requests:
      cpu: 10m
      memory: 10Mi
  env:
  - name: PLEX_TOKEN
    valueFrom:
      secretKeyRef:
        name: kometa-api-credentials
        key: PLEX_TOKEN
  - name: TMDB_APIKEY
    valueFrom:
      secretKeyRef:
        name: kometa-api-credentials
        key: TMDB_APIKEY
  - name: TAUTULLI_APIKEY
    valueFrom:
      secretKeyRef:
        name: kometa-api-credentials
        key: TAUTULLI_APIKEY
  - name: RADARR_TOKEN
    valueFrom:
      secretKeyRef:
        name: kometa-api-credentials
        key: RADARR_TOKEN
  - name: SONARR_TOKEN
    valueFrom:
      secretKeyRef:
        name: kometa-api-credentials
        key: SONARR_TOKEN
  command:
  - sh
  - -c
  - |
    cd /tmp
    curl -L https://github.com/a8m/envsubst/releases/download/v1.4.3/envsubst-Linux-arm64 -o envsubst
    chmod +x envsubst

    # Process all config files with environment variable substitution
    ./envsubst < /tmp/config.yml > /config/config.yml

    echo "Config files processed successfully"
    echo "Processed files:"
    ls -la /config/
  volumeMounts:
  - name: kometa-configmap
    mountPath: /tmp/config.yml
    subPath: config.yml
  - name: config
    mountPath: /config
  - name: tmp
    mountPath: /tmp