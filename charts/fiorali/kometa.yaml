name: kometa
namespace: downloader
image:
  repository: docker.io/kometateam/kometa
  tag: latest@sha256:46fc4bdd6f64dbd92655c6495d9f9d1a745845bd60fa13a7283755db48de8bc0
deployment:
  enabled: false
resources:
  limits:
    cpu: 250m
    memory: 256Mi
  requests:
    cpu: 100m
    memory: 125Mi
service:
  enabled: false
podDisruptionBudget:
  enabled: false
command:
  args: ["--run", "--read-only-config"]
cronjob:
  enabled: true
  schedule: "35 2 * * *"
volumeMounts:
- name: config
  mountPath: /config
- name: kometa-configmap
  mountPath: /config/movies.yml
  subPath: movies.yml
  readOnly: true
- name: kometa-configmap
  mountPath: /config/tv.yml
  subPath: tv.yml
  readOnly: true
volumes:
- name: config
  emptyDir: {}
- name: tmp
  emptyDir: {}
- name: kometa-configmap
  configMap:
    name: kometa-configmap
    defaultMode: 511
containerSecurityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: true
  privileged: false
podSecurityContext:
  fsGroup: 1000
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
networkpolicy:
  egress:
    internet: true
    namespaces: [tautulli]
initContainers:
  enabled: true
  containers:
  - name: kometa-init
    image: docker.io/alpine/curl:latest
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
        - ALL
      privileged: false
      readOnlyRootFilesystem: true
      runAsUser: 911
    resources:
      limits:
        cpu: 25m
        memory: 25Mi
      requests:
        cpu: 10m
        memory: 10Mi
    env:
    - name: PLEX_TOKEN
      valueFrom:
        secretKeyRef:
          name: kometa-api-credentials
          key: PLEX_TOKEN
    - name: TMDB_APIKEY
      valueFrom:
        secretKeyRef:
          name: kometa-api-credentials
          key: TMDB_APIKEY
    - name: TAUTULLI_APIKEY
      valueFrom:
        secretKeyRef:
          name: kometa-api-credentials
          key: TAUTULLI_APIKEY
    - name: RADARR_TOKEN
      valueFrom:
        secretKeyRef:
          name: kometa-api-credentials
          key: RADARR_TOKEN
    - name: SONARR_TOKEN
      valueFrom:
        secretKeyRef:
          name: kometa-api-credentials
          key: SONARR_TOKEN
    command:
    - sh
    - -c
    - |
      cd /tmp
      curl -L https://github.com/a8m/envsubst/releases/download/v1.4.3/envsubst-Linux-arm64 -o envsubst
      chmod +x envsubst
      # Process all config files with environment variable substitution
      ./envsubst < /tmp/config.yml > /config/config.yml
      echo "Config files processed successfully"
      echo "Processed files:"
      ls -la /config/
    volumeMounts:
    - name: kometa-configmap
      mountPath: /tmp/config.yml
      subPath: config.yml
    - name: config
      mountPath: /config
    - name: tmp
      mountPath: /tmp
imageUpdater:
  enabled: true
externalSecrets:
  - name: kometa-api-credentials
    data:
      - secretKey: PLEX_TOKEN
        remoteRef:
          key: /homelab/kometa/PLEX_TOKEN
      - secretKey: TMDB_APIKEY
        remoteRef:
          key: /homelab/kometa/TMDB_APIKEY
      - secretKey: TAUTULLI_APIKEY
        remoteRef:
          key: /homelab/kometa/TAUTULLI_APIKEY
      - secretKey: RADARR_TOKEN
        remoteRef:
          key: /homelab/kometa/RADARR_TOKEN
      - secretKey: SONARR_TOKEN
        remoteRef:
          key: /homelab/kometa/SONARR_TOKEN
configMap:
  enabled: true
  value: |-
    config.yml: |
      libraries:
        Movies:
          language: en
          collection_files:
            - file: /config/movies.yml
        TV Shows:
          language: en
          collection_files:
            - file: /config/tv.yml
      settings:
        cache: true
        cache_expiration: 60
        asset_directory: /config/assets
        asset_folders: true
        asset_depth: 0
        create_asset_folders: false
        dimensional_asset_rename: false
        download_url_assets: false
        show_missing_season_assets: false
        sync_mode: append
        minimum_items: 5
        default_collection_order: release
        delete_below_minimum: true
        delete_not_scheduled: false
        run_again_delay: 10
        missing_only_released: false
        only_filter_missing: false
        show_unmanaged: true
        show_filtered: false
        show_options: false
        show_missing: true
        show_missing_assets: true
        save_report: true
        show_report: true
        tvdb_language: eng
        playlist_sync_to_users: all
        verify_ssl: false
        run_order:
          - operations
          - metadata
          - collections
          - overlays
      plex:
        url: http://plex.downloader:32400
        token: ${PLEX_TOKEN}
        timeout: 60
        clean_bundles: false
        empty_trash: false
        optimize: false
      tmdb:
        apikey: ${TMDB_APIKEY}
        language: en
      tautulli:
        url: http://tautulli.tautulli:8181
        apikey: ${TAUTULLI_APIKEY}
      radarr:
        url: http://radarr.downloader:7878
        token: ${RADARR_TOKEN}
        add_missing: false
        root_folder_path: /media-movies-2
        monitor: false
        availability: released
        quality_profile: HD-1080p
        tag: kometa
        add_existing: false
        search: false
      sonarr:
        url: http://sonarr.downloader:8989
        token: ${SONARR_TOKEN}
        add_missing: true
        add_existing: false
        root_folder_path: /media-tv-2
        monitor: pilot
        quality_profile: HD-1080p
        language_profile: English
        series_type: standard
        season_folder: true
        tag: kometa
        search: true
        cutoff_search: false
    movies.yml: |
      collections:
        Tautulli Most Popular Movies:
          sync_mode: sync
          collection_order: custom
          tautulli_watched:
            list_days: 180
            list_size: 10
            list_minimum: 1
    tv.yml: |
      collections:
        Tautulli Most Popular TV Shows:
          smart_label: originally_available.desc
          sync_mode: sync
          imdb_search:
            type: tv_series, tv_mini_series
            limit: 10
          summary: The 10 most popular shows across the internet
          sonarr_add_missing: true
          sonarr_search: true
          sonarr_monitor: pilot
        Tautulli Most Popular:
          sync_mode: sync
          collection_order: custom
          summary: The 10 most popular shows from Plex users
          tautulli_popular:
            list_days: 180
            list_size: 10
