name: pihole
namespace: pihole
deployment:
  enabled: false
daemonSet:
  enabled: true
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 50%
terminationGracePeriodSeconds: 5
image:
  repository: docker.io/pihole/pihole
  tag: latest@sha256:91dc91ddd413bf461c283204558f8f21839851e9824799075a7ceff7c77eea40
containerPorts:
- containerPort: 8082
  name: pihole
  protocol: TCP
- containerPort: 53
  name: dns-tcp
  protocol: TCP
- containerPort: 53
  name: dns-udp
  protocol: UDP
- containerPort: 67
  name: client-udp
  protocol: UDP
resources:
  limits:
    cpu: 250m
    memory: 512Mi
  requests:
    cpu: 50m
    memory: 256Mi
probes:
  tcpSocket:
    port: 53
service:
  enabled: true
  loadBalancerIP: 192.168.20.21
  externalTrafficPolicy: Local
  type: LoadBalancer
  ports:
  - name: pihole
    port: 80
    protocol: TCP
    targetPort: pihole
  - name: dns-tcp
    port: 53
    protocol: TCP
    targetPort: dns-tcp
  - name: dns-udp
    port: 53
    protocol: UDP
    targetPort: dns-udp
  - name: metrics
    port: 9617
    protocol: TCP
    targetPort: metrics
env:
- name: TZ
  value: "America/Toronto"
- name: FTLCONF_webserver_api_password
  value: ''
- name: FTLCONF_webserver_port
  value: '8082,443s'
- name: DNSMASQ_LISTENING
  value: "all"
- name: FTLCONF_files_database
  value: "/tmp/pihole-FTL.db"
- name: FTLCONF_files_gravity
  value: "/tmp/gravity.db"
- name: FTLCONF_dns_CNAMEdeepInspect
  value: "true"
- name: FTLCONF_dns_ignoreLocalhost
  value: "true"
- name: FTLCONF_dns_dnssec
  value: "true"
- name: FTLCONF_dns_listeningMode
  value: "ALL"
- name: FTLCONF_webserver_api_excludeDomains
  value: |
    localhost.*;
    lb._dns-sd._udp.*;
    lb._dns-sd._tcp.*;
    _dns-sd._udp.*;
    _dns-sd._tcp.*;
    _services._dns-sd._udp.*;
    in-addr.arpa.*;
ingress:
  enabled: true
networkpolicy:
  ingress:
    allowAll: true
  egress:
    internet: true
containerSecurityContext:
  allowPrivilegeEscalation: true
  capabilities:
    add:
      - CHOWN
      - NET_BIND_SERVICE
      - NET_RAW
      - NET_ADMIN
      - SYS_NICE
  readOnlyRootFilesystem: false
  privileged: false
# podSecurityContext:
#   fsGroup: 1000
#   runAsNonRoot: true
#   runAsUser: 1000
imageUpdater:
  enabled: true
serviceMonitor:
  enabled: true
  appSelector: pihole
  port: "metrics"
initContainers:
  enabled: true
  containers:
  - name: load-configmaps
    image: docker.io/busybox:stable
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
        - ALL
      privileged: false
      readOnlyRootFilesystem: true
    resources:
      limits:
        cpu: 100m
        memory: 128Mi
      requests:
        cpu: 50m
        memory: 64Mi
    command:
      - sh
      - -c
      - chmod -R 777 /tmp
    volumeMounts:
      - name: tmp
        mountPath: /tmp
sidecarContainers:
  enabled: true
  containers:
  - name: cloudflared
    image: docker.io/crazymax/cloudflared:latest@sha256:9b4e856d18f6f6367330c56d91452f5fe3b6bd235f1210dcd9f6bd7373cad9be
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
        - ALL
      privileged: false
      readOnlyRootFilesystem: true
      runAsUser: 1000
    resources:
      limits:
        cpu: 100m
        memory: 256Mi
      requests:
        cpu: 50m
        memory: 128Mi
    ports:
      - containerPort: 5053
        name: cloudflared-udp
        protocol: UDP
      - containerPort: 49312
        name: cloudflared-met
        protocol: TCP
    startupProbe:
      tcpSocket:
        port: 5053
      failureThreshold: 15
      periodSeconds: 10
      successThreshold: 1
      timeoutSeconds: 15
    livenessProbe:
      tcpSocket:
        port: 5053
      failureThreshold: 3
      periodSeconds: 30
      successThreshold: 1
      timeoutSeconds: 5
    readinessProbe:
      tcpSocket:
        port: 5053
      failureThreshold: 2
      periodSeconds: 10
      successThreshold: 2
      timeoutSeconds: 5
    args:
      - proxy-dns
      - --port
      - "5053"
      - --upstream
      - "https://p5mp7qmshw.cloudflare-gateway.com/dns-query"
  - name: pihole-exporter
    image: docker.io/ekofr/pihole-exporter:latest@sha256:36dab68a7e4b2750802e2326d9340201dc498ac429cbd89cdfb45cbab3fef081
    imagePullPolicy: Always
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
        - ALL
      privileged: false
      readOnlyRootFilesystem: true
      runAsUser: 1000
    env:
      - name: PIHOLE_HOSTNAME
        value: 127.0.0.1
      - name: PIHOLE_PORT
        value: "8082"
      - name: PIHOLE_PASSWORD
        value: ""
      - name: PIHOLE_PROTOCOL
        value: "http"
    resources:
      limits:
        cpu: 50m
        memory: 128Mi
      requests:
        cpu: 25m
        memory: 64Mi
    startupProbe:
      tcpSocket:
        port: 9617
      failureThreshold: 15
      periodSeconds: 10
      successThreshold: 1
      timeoutSeconds: 15
    livenessProbe:
      tcpSocket:
        port: 9617
      failureThreshold: 3
      periodSeconds: 30
      successThreshold: 1
      timeoutSeconds: 5
    readinessProbe:
      tcpSocket:
        port: 9617
      failureThreshold: 2
      periodSeconds: 10
      successThreshold: 2
      timeoutSeconds: 5
    ports:
      - containerPort: 9617
        name: metrics
        protocol: TCP
  - name: config-sync
    image: docker.io/pihole/pihole:latest@sha256:91dc91ddd413bf461c283204558f8f21839851e9824799075a7ceff7c77eea40
    command: ["/bin/sh", "-c"]
    args:
      - |
        echo "Starting config sync service..."
        echo "Waiting 120 seconds for pihole to start..."
        for i in $(seq 1 12); do
          echo "$(( (13-i)*10 )) seconds remaining..."
          sleep 10 &
          wait $!
        done

        while true; do
          echo "Starting daily config sync..."
          echo "Importing regex whitelists..."
          while IFS= read -r line; do
            if [ ! -z "$line" ]; then
              pihole allow --allow-regex "$line"
            fi
          done < /tmp/whitelist_regex.list
          echo "Sync complete."
          echo "Sleeping for 24 hours until next sync..."
          sleep 86400
        done
    livenessProbe:
      exec:
        command:
        - sh
        - -c
        - ls $FTLCONF_files_gravity || exit 1
      failureThreshold: 3
      periodSeconds: 30
      successThreshold: 1
      timeoutSeconds: 5
    readinessProbe:
      exec:
        command:
        - sh
        - -c
        - ls $FTLCONF_files_gravity || exit 1
      failureThreshold: 2
      periodSeconds: 10
      successThreshold: 2
      timeoutSeconds: 5
    startupProbe:
      exec:
        command:
        - sh
        - -c
        - ls $FTLCONF_files_gravity || exit 1
      failureThreshold: 15
      periodSeconds: 10
      successThreshold: 1
      timeoutSeconds: 15
    env:
      - name: FTLCONF_files_database
        value: "/tmp/pihole-FTL.db"
      - name: FTLCONF_files_gravity
        value: "/tmp/gravity.db"
    volumeMounts:
    - mountPath: /tmp
      name: tmp
    - mountPath: /tmp/whitelist_regex.list
      name: pihole-configmap
      subPath: whitelist_regex.list
    resources:
      limits:
        cpu: 50m
        memory: 64Mi
      requests:
        cpu: 50m
        memory: 64Mi
volumeMounts:
- name: pihole-configmap
  mountPath: /etc/pihole/setupVars.conf
  subPath: setupVars.conf
- name: pihole-configmap
  mountPath: /etc/pihole/pihole-FTL.conf
  subPath: pihole-FTL.conf
- name: pihole-configmap
  mountPath: /etc/pihole/adlists.list
  subPath: adlists.list
- name: pihole-configmap
  mountPath: /etc/pihole/custom.list
  subPath: custom.list
- name: pihole-configmap
  mountPath: /etc/pihole/whitelist.list
  subPath: whitelist.list
- name: tmp
  mountPath: /tmp
volumes:
- name: pihole-configmap
  configMap:
    name: pihole-configmap
- name: tmp
  emptyDir:
    sizeLimit: 256Mi
    medium: Memory
configMap:
  enabled: true
  value: |-
    setupVars.conf: |
      PIHOLE_INTERFACE=eth0
      IPV4_ADDRESS=0.0.0.0
      IPV6_ADDRESS=
      DNSMASQ_LISTENING=all
      QUERY_LOGGING=true
      INSTALL_WEB_SERVER=true
      INSTALL_WEB_INTERFACE=true
      LIGHTTPD_ENABLED=true
      WEBPASSWORD=
      BLOCKING_ENABLED=true
      DNS_FQDN_REQUIRED=true
      DNS_BOGUS_PRIV=true
      DNSSEC=true

      PIHOLE_DNS_1=127.0.0.1#5053
      PIHOLE_DNS_2=127.0.0.1#5053

      TEMPERATUREUNIT=c
      WEBUIBOXEDLAYOUT=boxed
      WEBTHEME=default-dark
    pihole-FTL.conf: |
      # Performance
      MAXDBDAYS=7
      PRIVACYLEVEL=0
      RATE_LIMIT=0/0

      # Kubernetes-safe logging
      LOGFILE=/dev/stdout
      LOG_FTL=true

      # Don't bind to specific IPs
      RESOLVE_IPV6=no
    adlists.list: |
      https://raw.githubusercontent.com/r0xd4n3t/pihole-adblock-lists/main/pihole_adlists.txt
    custom.list: |
      192.168.20.20 *.fiora.li
      192.168.20.21 pihole.fiora.li
      192.168.20.22 plex.fiora.li
    whitelist_regex.list: |
      (^|\.)spe\.schoolmessenger\.com
      (^|\.)braze\.com$
      (^|\.)thepiratebay\.org$
      (^|\.)apibay\.org$
      ^(wbsapi|static|sct01-ws|prod\.rudderstack)\.withings\.net$
