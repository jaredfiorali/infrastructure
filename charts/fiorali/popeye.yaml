name: popeye
namespace: popeye
image:
  repository: docker.io/derailed/popeye
  tag: v0.22.0@sha256:885992c4a6db77a9ffceddea840f6a4b29f60381d87d5ae74bd814af84f5b65d
deployment:
  enabled: false
resources:
  limits:
    cpu: '1'
    memory: 1Gi
service:
  enabled: false
podDisruptionBudget:
  enabled: true
command:
  args: ["-A", "-o", "json", "--force-exit-zero", "-f", "/spinach.yaml", "--push-gtwy-url", "http://prometheus-prometheus-pushgateway.monitoring:9091"]
cronjob:
  enabled: true
  schedule: "*/10 * * * *"
volumeMounts:
- name: popeye-configmap
  mountPath: /spinach.yaml
  subPath: spinach.yaml
  readOnly: true
- name: tmp
  mountPath: /tmp
volumes:
- name: popeye-configmap
  configMap:
    name: popeye-configmap
    defaultMode: 511
- name: tmp
  emptyDir: {}
networkpolicy:
  egress:
    namespaces:
    - monitoring
containerSecurityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: true
  privileged: false
podSecurityContext:
  fsGroup: 2000
  runAsNonRoot: true
clusterRoleBinding:
  enabled: true
clusterRole:
  enabled: true
  rules:
  - apiGroups: [""]
    resources:
    - configmaps
    - endpoints
    - namespaces
    - nodes
    - persistentvolumes
    - persistentvolumeclaims
    - pods
    - secrets
    - serviceaccounts
    - services
    - events
    verbs: ["get", "list"]
  - apiGroups: ["apps"]
    resources:
    - daemonsets
    - deployments
    - statefulsets
    - replicasets
    verbs: ["get", "list"]
  - apiGroups: ["networking.k8s.io"]
    resources:
    - ingresses
    - networkpolicies
    verbs: ["get", "list"]
  - apiGroups: ["batch"]
    resources:
    - cronjobs
    - jobs
    verbs: ["get", "list"]
  - apiGroups: ["gateway.networking.k8s.io"]
    resources:
    - gatewayclasses
    - gateways
    - httproutes
    verbs: ["get", "list"]
  - apiGroups: ["autoscaling"]
    resources:
    - horizontalpodautoscalers
    verbs: ["get", "list"]
  - apiGroups: ["policy"]
    resources:
    - poddisruptionbudgets
    - podsecuritypolicies
    verbs: ["get", "list"]
  - apiGroups: ["rbac.authorization.k8s.io"]
    resources:
    - clusterroles
    - clusterrolebindings
    - roles
    - rolebindings
    verbs: ["get", "list"]
  - apiGroups: ["metrics.k8s.io"]
    resources:
    - pods
    - nodes
    verbs: ["get", "list"]
prometheusRules:
  enabled: true
  rules:
    - alert: PopeyeLowScore
      annotations:
        description: If the popeye linter has a low score, it indicates that the cluster is not healthy.
        summary: Popeye linter score is low.
      expr: popeye_report_score < 100
      for: 5m
      keep_firing_for: 10m
      labels:
        issue: Popeye score is less than 100.
        severity: critical
    - alert: PopeyeErrorsDetected
      annotations:
        description: If the popeye linter has detected errors, it indicates that the cluster is not healthy.
        summary: Popeye has detected errors.
      expr: popeye_severity_total{severity="error"} > 0
      for: 5m
      keep_firing_for: 10m
      labels:
        issue: Popeye has detected errors in the {{$labels.namespace}} namespace.
        severity: critical
    - alert: PopeyeWarningDetected
      annotations:
        description: If the popeye linter has detected warnings, it indicates that the cluster is not healthy.
        summary: Popeye has detected warnings.
      expr: popeye_severity_total{severity="warn"} > 0
      for: 5m
      keep_firing_for: 10m
      labels:
        issue: Popeye has detected warnings in the {{$labels.namespace}} namespace.
        severity: critical
configMap:
  enabled: true
  name: spinach.yaml
  value: |-
    popeye:
      # Checks resources against reported metrics usage.
      # If over/under these thresholds a linter warning will be issued.
      # Your cluster must run a metrics-server for these to take place!
      allocations:
        cpu:
          underPercUtilization: 200 # Checks if cpu is under allocated by more than 200% at current load.
          overPercUtilization:  50  # Checks if cpu is over allocated by more than 50% at current load.
        memory:
          underPercUtilization: 200 # Checks if mem is under allocated by more than 200% at current load.
          overPercUtilization:  50  # Checks if mem is over allocated by more than 50% usage at current load.

      # Excludes excludes certain resources from Popeye scans
      excludes:
        global:
          fqns: [rx:^kube-, rx:^loki, rx:^longhorn-system, rx:^argocd] # => excludes all third party resources
          labels:
            app.kubernetes.io/part-of: [kube-state-metrics, kube-prometheus-stack, prometheus-node-exporter] # => excludes all third party resources
            app.kubernetes.io/managed-by: [prometheus-operator] # => excludes all third party resources
            managed-by: [prometheus-operator] # => excludes all third party resources
            app.kubernetes.io/name: [prometheus-pushgateway] # => excludes all third party resources
            skip-popeye: ["true"] # => excludes all resources with labels skip-popeye=true
          # [Sample]
          annotations:
            fred: [blee, duh] # => exclude any resources with annotations matching either fred=blee or fred=duh
          # => exclude specified codes (https://popeyecli.io/docs/codes.html)
          codes: ["1109", "406"]

        # Configure individual resource linters
        linters:
          # Configure the namespaces linter for v1/namespaces
          namespaces:
            # Exclude these codes for all namespace resources straight up or via regex.
            codes: ["1109"] # => exclude codes 100, 220, 225, ...
            #  Excludes specific namespaces from the scan
            instances:
              - fqns: [kube-public, kube-system] # => skip ns kube-public and kube-system

          # Skip secrets
          cronjobs:
            instances:
              - fqns: [rx:^popeye]
                codes: [1503] # => skip code 1503 for namespace popeye

          # Skip services in namespace timemachine.
          services:
            instances:
              - fqns: [rx:^timemachine, rx:^downloader]
                codes: [1103] # => skip code 1103 for timemachine service

          networkpolicies:
            instances:
              # - fqns: [rx:^downloader]
              #   codes: [1207, 1206]
              - labels:
                  app: [home-assistant, influxdb, linkding, scrypted, sillytavern, unifi-poller] # Exclude codes for any networkpolicies with specified labels
                  codes: [1206]
                  app: [linkding, plex, prowlarr, radarr, sonarr, transmission, tautulli] # Exclude codes for any networkpolicies with specified labels
                  codes: [1207]

          # Configure the pods linter for v1/pods.
          pods:
            instances:
              # TODO: jfiorali - This needs to be more specific, and hopefully eliminated once ro is rolled out
              - fqns: [rx:^dawarich, rx:^downloader, rx:^emulatorjs, rx:^home-assistant, rx:^timemachine]
                codes: [302, 306] # => skip code 207 for namespace popeye
              - fqns: [rx:^popeye]
                codes: [203, 207] # => skip code 207 for namespace popeye
              - labels:
                  app: [fred,blee] # Exclude codes 102, 105 for any pods with labels app=fred or app=blee
                codes: [102, 105]

      resources:
        # Configure node resources.
        node:
          # Limits set a cpu/mem threshold in % ie if cpu|mem > limit a lint warning is triggered.
          limits:
            # CPU checks if current CPU utilization on a node is greater than 90%.
            cpu:    90
            # Memory checks if current Memory utilization on a node is greater than 80%.
            memory: 80

        # Configure pod resources
        pod:
          # Restarts check the restarts count and triggers a lint warning if above threshold.
          restarts: 3
          # Check container resource utilization in percent.
          # Issues a lint warning if about these threshold.
          limits:
            cpu:    80
            memory: 75


      # [New!] overrides code severity
      overrides:
        # Code specifies a custom severity level ie critical=3, warn=2, info=1
        - code: 1206
          severity: 1
        - code: 1207
          severity: 1

      # Configure a list of allowed registries to pull images from.
      # Any resources not using the following registries will be flagged!
      registries:
        - quay.io
        - docker.io
        - ghcr.io
