name: transmission
namespace: downloader
deployment:
  enabled: true
replicaCount: 1
image:
  repository: docker.io/linuxserver/transmission
  tag: latest@sha256:0bd8f5b39f2a2f61dc35a07d60d80e6eb73e3382f7be0280c879e36237c52d90
containerPorts:
- containerPort: 9091
  name: transmission
resources:
  limits:
    cpu: 1500m
    memory: 2Gi
  requests:
    cpu: 1000m
    memory: 1Gi
probes:
  exec:
    command:
    - sh
    - -c
    - if [[ $(pgrep transmission | wc -l) -ne 1 ]]; then exit 1; fi
service:
  enabled: true
  ports:
  - port: 9091
    name: transmission
    targetPort: transmission
env:
- name: PUID
  value: "1000"
- name: PGID
  value: "1000"
- name: TZ
  value: "America/Toronto"
- name: S6_READ_ONLY_ROOT
  value: "1"
- name: S6_YES_I_WANT_A_WORLD_WRITABLE_RUN_BECAUSE_KUBERNETES
  value: "1"
- name: S6_VERBOSITY
  value: "2"
ingress:
  enabled: true
volumeMounts:
- name: media-bittorrent
  mountPath: /media-bittorrent
- name: config
  mountPath: /config
- name: run
  mountPath: /run
volumes:
- name: transmission-configmap
  configMap:
    name: transmission-configmap
    defaultMode: 511
- name: media-bittorrent
  persistentVolumeClaim:
    claimName: media-bittorrent
- name: port-forward
  emptyDir: {}
- name: config
  emptyDir: {}
- name: run
  emptyDir: {}
networkpolicy:
  ingress:
    internal: true
  egress:
    internet: true
initContainers:
  enabled: true
  containers:
  - name: gluetun
    image: docker.io/qmcgaw/gluetun:latest@sha256:6a59b7901068b7c50ef52200152db3afd4b9cebc13e272b2169de4cdcad91006
    resources:
      limits:
        cpu: 1500m
        memory: 1Gi
      requests:
        cpu: 1000m
        memory: 500Mi
    imagePullPolicy: IfNotPresent
    restartPolicy: Always
    securityContext:
      privileged: true
      capabilities:
        add:
        - NET_ADMIN
    startupProbe:
      successThreshold: 1
      failureThreshold: 18
      periodSeconds: 10
      timeoutSeconds: 5
      exec:
        command:
        - sh
        - -c
        - wget -q -T 10 -t 2 127.0.0.1:9999 && echo 0 || echo 1
    livenessProbe:
      successThreshold: 1
      failureThreshold: 3
      periodSeconds: 30
      timeoutSeconds: 5
      exec:
        command:
        - sh
        - -c
        - wget -q -T 10 -t 2 127.0.0.1:9999 && echo 0 || echo 1
    readinessProbe:
      successThreshold: 2
      failureThreshold: 2
      periodSeconds: 10
      timeoutSeconds: 5
      exec:
        command:
        - sh
        - -c
        - wget -q -T 10 -t 2 127.0.0.1:9999 && echo 0 || echo 1
    env:
    - name: VPN_SERVICE_PROVIDER
      value: "private internet access"
    - name: OPENVPN_FLAGS
      value: "--fast-io --sndbuf 1024000 --rcvbuf 1024000 --compress"
    - name: OPENVPN_CIPHERS
      value: "aes-128-cbc"
    - name: OPENVPN_USER
      valueFrom:
        secretKeyRef:
          name: pia-credentials
          key: username
    - name: OPENVPN_PASSWORD
      valueFrom:
        secretKeyRef:
          name: pia-credentials
          key: password
    - name: SERVER_REGIONS
      value: "CA Toronto"
    - name: PORT_FORWARD_ONLY
      value: "true"
    - name: VPN_PORT_FORWARDING
      value: "on"
    - name: VPN_PORT_FORWARDING_STATUS_FILE
      value: "/gluetun/forwarded_port.txt"
    ports:
    - containerPort: 8000
      name: gluetun
    volumeMounts:
    - name: port-forward
      mountPath: /gluetun
  - name: ping
    image: docker.io/busybox:stable
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        add:
        - NET_ADMIN
      privileged: false
      readOnlyRootFilesystem: true
    resources:
      limits:
        cpu: 100m
        memory: 100Mi
      requests:
        cpu: 100m
        memory: 100Mi
    command:
    - sh
    - -c
    - |
      while ! ping -c 1 google.com; do
        echo "Ping failed, retrying in 5"
        sleep 5
      done
      echo "ping successful, exiting"
  - name: update-peer-port
    image: docker.io/busybox:stable
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
        - ALL
      privileged: false
      readOnlyRootFilesystem: true
      runAsUser: 911
    resources:
      limits:
        cpu: 100m
        memory: 100Mi
      requests:
        cpu: 100m
        memory: 100Mi
    command:
    - sh
    - -c
    - |
      while [ ! -f "/gluetun/forwarded_port.txt" ]; do
        echo "Waiting for port forward..."
        sleep 5
      done
      cp /tmp/settings.json /config/settings.json
      export FORWARDED_PORT="$(cat /gluetun/forwarded_port.txt)"
      sed -i "s/\"peer-port\":.*/\"peer-port\": $FORWARDED_PORT,/g" /config/settings.json
      echo "transmission port updated to $FORWARDED_PORT"
      cat /config/settings.json
    volumeMounts:
    - name: transmission-configmap
      mountPath: /tmp/settings.json
      subPath: settings.json
      readOnly: true
    - name: port-forward
      mountPath: /gluetun
    - name: config
      mountPath: /config
dnsPolicy: "None"
dnsConfig:
  nameservers:
  - 127.0.0.1
containerSecurityContext:
  enabled: true
  readOnlyRootFilesystem: true
  allowPrivilegeEscalation: true
  capabilities:
    drop:
    - ALL
    add:
    - CHOWN
    - SETUID
    - SETGID
  seccompProfile:
    type: RuntimeDefault
podSecurityContext: {} # gluetun needs root access to make changes to network settings
imageUpdater:
  enabled: true
configMap:
  enabled: true
  value: |-
    settings.json: |
      {
        "alt-speed-down": 50,
        "alt-speed-enabled": false,
        "alt-speed-time-begin": 540,
        "alt-speed-time-day": 127,
        "alt-speed-time-enabled": false,
        "alt-speed-time-end": 1020,
        "alt-speed-up": 50,
        "announce-ip": "",
        "announce-ip-enabled": false,
        "anti-brute-force-enabled": false,
        "anti-brute-force-threshold": 100,
        "bind-address-ipv4": "0.0.0.0",
        "bind-address-ipv6": "::",
        "blocklist-enabled": false,
        "blocklist-url": "http://www.example.com/blocklist",
        "cache-size-mb": 4,
        "default-trackers": "",
        "dht-enabled": true,
        "download-dir": "/media-bittorrent/completed",
        "download-queue-enabled": true,
        "download-queue-size": 4,
        "encryption": 0,
        "idle-seeding-limit": 30,
        "idle-seeding-limit-enabled": false,
        "incomplete-dir": "/media-bittorrent/incomplete",
        "incomplete-dir-enabled": true,
        "lpd-enabled": true,
        "message-level": 2,
        "peer-congestion-algorithm": "",
        "peer-id-ttl-hours": 6,
        "peer-limit-global": 200,
        "peer-limit-per-torrent": 100,
        "peer-port": 49003,
        "peer-port-random-high": 65535,
        "peer-port-random-low": 49152,
        "peer-port-random-on-start": false,
        "peer-socket-tos": "le",
        "pex-enabled": true,
        "port-forwarding-enabled": true,
        "preallocation": 1,
        "prefetch-enabled": true,
        "queue-stalled-enabled": true,
        "queue-stalled-minutes": 30,
        "ratio-limit": 2,
        "ratio-limit-enabled": true,
        "rename-partial-files": true,
        "rpc-authentication-required": false,
        "rpc-bind-address": "0.0.0.0",
        "rpc-enabled": true,
        "rpc-host-whitelist": "",
        "rpc-host-whitelist-enabled": false,
        "rpc-password": "",
        "rpc-port": 9091,
        "rpc-socket-mode": "0750",
        "rpc-url": "/transmission/",
        "rpc-username": "",
        "rpc-whitelist": "",
        "rpc-whitelist-enabled": false,
        "scrape-paused-torrents-enabled": true,
        "script-torrent-added-enabled": false,
        "script-torrent-added-filename": "",
        "script-torrent-done-enabled": false,
        "script-torrent-done-filename": "",
        "script-torrent-done-seeding-enabled": false,
        "script-torrent-done-seeding-filename": "",
        "seed-queue-enabled": false,
        "seed-queue-size": 10,
        "speed-limit-down": 100,
        "speed-limit-down-enabled": false,
        "speed-limit-up": 100,
        "speed-limit-up-enabled": false,
        "start-added-torrents": true,
        "tcp-enabled": true,
        "torrent-added-verify-mode": "fast",
        "trash-original-torrent-files": false,
        "umask": "000",
        "upload-slots-per-torrent": 14,
        "utp-enabled": true,
        "watch-dir": "/media-bittorrent/watch",
        "watch-dir-enabled": false
      }
